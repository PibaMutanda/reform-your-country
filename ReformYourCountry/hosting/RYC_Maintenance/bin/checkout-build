#!/bin/bash

. config
. common_function

APP_DIR_NAME=$APP_NAME
APP_SVN_PATH=trunk/$APP_NAME

FRAMEWORK_DIR_NAME=$FRAMEWORK_NAME
FRAMEWORK_SVN_PATH=trunk/$FRAMEWORK_NAME

ensureFolderExists $BUILD_FOLDER
ensureFolderExists $BACKUP_FOLDER/oldwars

cd $BUILD_FOLDER

function backupOldWar(){
  cp -i $WEBAPPS_FOLDER/ROOT.war $BACKUP_FOLDER/oldwars/$OLD_WAR_COPY_NAME
}
function checkout(){
  mkdir $1
  cd $1
  svn checkout $2 .
}
function update(){
  cd $1
  svn revert -R . && svn update
}
function buildWar(){
  backupOldWar
  ant -Dtype=$1 war
}

#first we checkout or update the RYC framework sourcecode
if [ -d "./$FRAMEWORK_DIR_NAME" ]
then
  update $FRAMEWORK_DIR_NAME
else 
  checkout $FRAMEWORK_DIR_NAME $FRAMEWORK_SVN_ADRESS/$FRAMEWORK_SVN_PATH
fi
cd $BUILD_FOLDER

#second we do the same with the app
if [ -d "./$APP_DIR_NAME" ]
then
  update $APP_DIR_NAME
else 
  checkout $APP_DIR_NAME $APP_SVN_ADRESS/$APP_SVN_PATH
fi

#first we build the app
buildWar $APP_ENV
